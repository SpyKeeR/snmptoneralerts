# üì¶ Guide d'installation et de configuration - SNMP Toner Alerts

> **Documentation compl√®te pour l'installation, la configuration avanc√©e et le d√©pannage du plugin**

---

## üìã Table des mati√®res

1. [‚ö†Ô∏è Nouveaut√©s v1.1.0](#Ô∏è-nouveaut√©s-v110)
2. [Pr√©requis](#-pr√©requis)
3. [Installation](#-installation)
4. [Configuration](#Ô∏è-configuration)
5. [Actions automatiques](#-actions-automatiques)
6. [Templates de notifications](#-templates-de-notifications)
7. [Architecture technique](#Ô∏è-architecture-technique)
8. [D√©pannage](#-d√©pannage)

---

## ‚ö†Ô∏è Nouveaut√©s v1.1.0

> **Version initiale avec architecture compl√®te**

### ‚ú® Fonctionnalit√©s principales

1. **Message-ID RFC-compliant** 
   - Les Message-ID des emails utilisent maintenant des points au lieu de backslashes
   - Format : `GlpiPlugin.Snmptoneralerts.TonerAlert.{id}.{timestamp}@{domain}`
   - Compatible avec tous les serveurs de messagerie

2. **Affichage nom + r√©f√©rence des cartouches**
   - Les notifications affichent maintenant : `HP 305A Black (Ref: CE410A)`
   - Au lieu de seulement : `Ref: CE410A`
   - Plus facile pour identifier et commander les bonnes cartouches

3. **Support des cartouches tri-color**
   - Fallback automatique pour les cartouches 3 couleurs en 1
   - Si `cyan`, `magenta` ou `yellow` non trouv√©s ‚Üí cherche `tri-color`
   - Simplifie la configuration pour les imprimantes avec cartouche multicolore

4. **Liens de configuration rapide**
   - 3 boutons d'acc√®s direct depuis la page de configuration :
     - ‚öôÔ∏è Activer/Configurer les CronTasks
     - üìß Configurer les notifications
     - üìã Mod√®les de notifications

### üé® Am√©liorations

1. **Configuration simplifi√©e**
   - Seulement 2 param√®tres m√©tier essentiels (seuil, max_alerts)
   - Configuration claire sans duplication avec GLPI
   - Liens de configuration rapide int√©gr√©s

2. **CronTasks activ√©s par d√©faut**
   - Les 3 CronTasks sont activ√©s automatiquement √† l'installation
   - Plus besoin d'activation manuelle
   - Gain de temps lors de la premi√®re configuration

3. **Nettoyage complet √† la d√©sinstallation**
   - Supprime toutes les traces dans `glpi_configs`
   - Supprime les notifications et templates associ√©s
   - Aucun r√©sidu dans la base de donn√©es

### üêõ Corrections de bugs

1. **Double symbole % corrig√©**
   - Les notifications affichaient `20%%` au lieu de `20%`
   - Maintenant corrig√© dans le code

2. **Nombre d'imprimantes corrig√©**
   - Affichage correct du nombre d'imprimantes concern√©es dans les logs

3. **Liaison template/notification**
   - Association automatique entre templates et notifications
   - Notifications fonctionnelles d√®s l'installation

### üìñ Documentation

- **CHANGELOG.md** : Historique complet des versions
- **README.md** : Configuration de base mise √† jour avec nouveau workflow
- **INSTALL.md** : Ce guide, enti√®rement revu pour la v1.1.0
- **version.json** : M√©tadonn√©es enrichies avec changelog structur√©

---

## üîß Pr√©requis

### Version minimale requise

| Composant | Version | V√©rification |
|-----------|---------|--------------|
| **GLPI** | 11.0.0+ | Administration ‚Üí √Ä propos |
| **PHP** | 8.2+ | `php -v` |
| **MySQL / MariaDB** | - | Via GLPI |

### Extensions PHP requises

```bash
# V√©rifier les extensions install√©es
php -m | grep -E 'mysqli|pdo_mysql|mbstring|json'

# Si manquantes, installer:
sudo apt-get install php8.2-mysql php8.2-mbstring
sudo systemctl restart apache2  # ou php-fpm
```

### Plugins GLPI requis

| Plugin | R√¥le | √âtat |
|--------|------|------|
| **NetDiscovery** | D√©couverte r√©seau | ‚úÖ Actif |
| **NetInventory** | Inventaire SNMP | ‚úÖ Actif |

**V√©rifier l'inventaire SNMP** :

```sql
-- Doit retourner des enregistrements
SELECT p.name, c.property, c.value
FROM glpi_printers p
JOIN glpi_printers_cartridgeinfos c ON c.printers_id = p.id
LIMIT 10;
```

Si aucun r√©sultat :
1. V√©rifier que NetInventory est configur√© avec les credentials SNMP
2. Relancer un inventaire sur une imprimante test
3. V√©rifier que l'imprimante supporte SNMP v1/v2c/v3

### Permissions syst√®me

```bash
# Le serveur Web doit pouvoir lire le plugin
chown -R www-data:www-data /var/www/html/glpi/plugins/snmptoneralerts
chmod -R 755 /var/www/html/glpi/plugins/snmptoneralerts

# V√©rifier l'utilisateur du serveur Web
ps aux | grep -E 'apache|nginx|php-fpm' | head -1
```

---

## üì• Installation

### M√©thode 1 : T√©l√©chargement manuel (recommand√©)

**Depuis l'interface GitHub :**

1. Aller sur [https://github.com/SpyKeeR/snmptoneralerts](https://github.com/SpyKeeR/snmptoneralerts)
2. Cliquer sur le bouton **Code** (vert)
3. S√©lectionner **Download ZIP**
4. Sauvegarder `snmptoneralerts-main.zip` sur votre ordinateur

**Installation sur le serveur :**

```bash
# 1. Transf√©rer le fichier ZIP sur le serveur (via SCP, FTP, ou autre)
# Exemple avec SCP :
scp snmptoneralerts-main.zip user@serveur:/tmp/

# 2. Se connecter au serveur et extraire
cd /var/www/html/glpi/plugins
unzip /tmp/snmptoneralerts-main.zip

# 3. Renommer le dossier (retirer le suffixe -main ou -master)
mv snmptoneralerts-main snmptoneralerts

# 4. Permissions
chown -R www-data:www-data snmptoneralerts
chmod -R 755 snmptoneralerts

# 5. V√©rifier la structure
ls -la snmptoneralerts/
# Doit contenir: setup.php, hook.php, src/, front/, locales/
```

**Alternative : T√©l√©chargement direct depuis le serveur**

```bash
# T√©l√©charger directement l'archive ZIP depuis GitHub
cd /var/www/html/glpi/plugins
wget https://github.com/SpyKeeR/snmptoneralerts/archive/refs/heads/main.zip -O snmptoneralerts.zip

# Extraire et renommer
unzip snmptoneralerts.zip
mv snmptoneralerts-main snmptoneralerts

# Permissions
chown -R www-data:www-data snmptoneralerts
chmod -R 755 snmptoneralerts
```

### M√©thode 2 : Git (recommand√© pour les d√©veloppeurs)

```bash
# 1. Cloner le d√©p√¥t
cd /var/www/html/glpi/plugins
git clone https://github.com/SpyKeeR/snmptoneralerts.git

# 2. Installer les d√©pendances (si Composer)
cd snmptoneralerts
composer install --no-dev --optimize-autoloader

# 3. Permissions
cd ..
chown -R www-data:www-data snmptoneralerts
chmod -R 755 snmptoneralerts
```

### Activation du plugin

1. Aller dans **Configuration ‚Üí Plugins**
2. Localiser "SNMP Toner Alerts" dans la liste
3. **Statut** : Nouveau ‚Üí Cliquer sur **Installer**
4. **Statut** : Non actif ‚Üí Cliquer sur **Activer**

### V√©rification de l'installation

**V√©rifier les tables cr√©√©es** :

```sql
-- Doit retourner 4 tables
SHOW TABLES LIKE 'glpi_plugin_snmptoneralerts%';

-- Structure attendue:
-- glpi_plugin_snmptoneralerts_alerts
-- glpi_plugin_snmptoneralerts_configs
-- glpi_plugin_snmptoneralerts_excludedprinters
-- glpi_plugin_snmptoneralerts_states
```

**V√©rifier les CronTasks** :

```sql
SELECT name, state FROM glpi_crontasks WHERE itemtype = 'PluginSnmptonealertsTonerMonitor';
```

**V√©rifier l'acc√®s √† la configuration** :

1. Menu GLPI ‚Üí **Configuration**
2. V√©rifier pr√©sence de **SNMP Toner Alerts** dans la section "Plugins"

---

## ‚öôÔ∏è Configuration

### Configuration de base (v1.1.0 - Simplifi√©e)

Le plugin a √©t√© **grandement simplifi√©** dans la version 1.1.0. La configuration se fait maintenant en **2 param√®tres** + acc√®s rapide aux Actions automatiques.

#### √âtape 1 : Configuration des param√®tres

1. Aller dans **Configuration ‚Üí SNMP Toner Alerts**

2. **Seuil d'alerte (%)** :
   - Valeur par d√©faut : `20%`
   - Plage recommand√©e : `15%` √† `25%`
   - ‚ö†Ô∏è Trop bas = trop d'alertes / Trop haut = risque de panne

3. **Nombre maximum d'alertes quotidiennes** :
   - Valeur par d√©faut : `3`
   - Apr√®s d√©passement ‚Üí passage en r√©capitulatif hebdomadaire
   - Recommand√© : `3` √† `5`

4. Cliquer sur **Enregistrer**

#### √âtape 2 : Utiliser les liens de configuration rapide

La page de configuration affiche maintenant **3 boutons d'acc√®s rapide** :

1. **‚öôÔ∏è Activer/Configurer les CronTasks**
   - Ouvre directement la liste des Actions automatiques du plugin
   - Les 3 CronTasks (CheckTonerLevels, SendDailyAlerts, SendWeeklyRecap) sont **activ√©s par d√©faut**
   - Vous pouvez ajuster les fr√©quences et horaires si besoin

2. **üìß Configurer les notifications**
   - Ouvre la liste des notifications actives
   - Permet d'ajouter/modifier les destinataires des emails

3. **üìã Mod√®les de notifications**
   - Ouvre les templates d'emails
   - Permet de personnaliser le contenu des alertes

#### Philosophie de configuration

Le plugin se concentre sur les **param√®tres m√©tier sp√©cifiques** au monitoring des toners :
- ‚úÖ **Seuil d'alerte (%)** : Seuil m√©tier pour d√©clencher les alertes
- ‚úÖ **Nombre max d'alertes quotidiennes** : Logique de basculement journalier/hebdomadaire

Les autres param√®tres (destinataires, horaires, activation) sont g√©r√©s par les **fonctionnalit√©s natives de GLPI** :
- üìß Destinataires ‚Üí **Configuration ‚Üí Notifications ‚Üí Notifications**
- ‚è∞ Horaires ‚Üí **Configuration ‚Üí Actions automatiques** (CronTasks)
- ‚úÖ Activation ‚Üí CronTasks activ√©s par d√©faut

**üí° Avantage** : Configuration claire, sans duplication avec GLPI

### V√©rification de la configuration

```sql
-- Voir la configuration active
SELECT * FROM glpi_plugin_snmptoneralerts_configs ORDER BY id DESC LIMIT 1;
```

### Exclusion d'imprimantes

Certaines imprimantes remontent des donn√©es SNMP incorrectes (100% constant, valeurs n√©gatives, etc.).

**Via l'interface** :

1. **Configuration ‚Üí SNMP Toner Alerts** ‚Üí Section "Gestion des imprimantes exclues"
2. **Imprimante** : S√©lectionner dans la liste d√©roulante
3. **Raison** : Exemple "Donn√©es SNMP aberrantes" ou "Imprimante hors service"
4. Cliquer sur **Ajouter**

**Via SQL (si besoin)** :

```sql
-- Lister les imprimantes avec donn√©es SNMP
SELECT p.id, p.name
FROM glpi_printers p
JOIN glpi_printers_cartridgeinfos c ON c.printers_id = p.id
GROUP BY p.id;

-- Exclure une imprimante (ID 42)
INSERT INTO glpi_plugin_snmptoneralerts_excludedprinters (printers_id, reason)
VALUES (42, 'Donn√©es SNMP incorrectes');

-- Voir les exclusions
SELECT e.id, p.name, e.reason, e.excluded_at
FROM glpi_plugin_snmptoneralerts_excludedprinters e
JOIN glpi_printers p ON p.id = e.printers_id;
```

### Gestion des cartouches et r√©f√©rences (v1.1.0 - Am√©lior√©)

Le plugin affiche automatiquement les **noms et r√©f√©rences de cartouches** dans les notifications en les associant aux propri√©t√©s SNMP.

**üìã Format d'affichage dans les notifications** :

```
- Toner noir: 19% (HP 305A Black (Ref: CE410A)) [Alerte 2/3]
- Toner cyan: 10% (HP 305 Tri-color (Ref: CE411A)) [Alerte 1/3]
- Toner magenta: 8% (Non d√©fini) [Alerte 3/3]
```

#### Configuration des r√©f√©rences

1. Aller dans **Gestion ‚Üí Mod√®les d'imprimantes**
2. S√©lectionner le mod√®le (ex: "HP LaserJet Pro 400")
3. Onglet **Cartouches compatibles** ‚Üí Ajouter les r√©f√©rences

4. √âditer chaque cartouche dans **Gestion ‚Üí Cartouches** :
   - Champ **R√©f√©rence** : `CF400X`
   - Champ **Nom** : `HP 305A Black`
   - Champ **Commentaire** : Ajouter la couleur pour le mapping :
     * `black` ou `noir` ‚Üí Toner noir
     * `cyan` ‚Üí Toner cyan
     * `magenta` ‚Üí Toner magenta
     * `yellow` ou `jaune` ‚Üí Toner jaune
     * `tri-color` ou `tricolor` ou `couleur` ‚Üí Cartouche multicolore (fallback)
     * `drum black` ‚Üí Bloc image noir

#### Mapping SNMP ‚Üí Cartouches (avec fallback tri-color)

Le plugin utilise la correspondance suivante :

| Propri√©t√© SNMP | Mots-cl√©s recherch√©s (priorit√©) | Fallback |
|----------------|----------------------------------|----------|
| `tonerblack` | black, noir, bk | - |
| `tonercyan` | cyan, c | tri-color, tricolor, couleur |
| `tonermagenta` | magenta, m | tri-color, tricolor, couleur |
| `toneryellow` | yellow, jaune, y | tri-color, tricolor, couleur |
| `drumblack` | drum black, drum noir | - |
| `drumcyan` | drum cyan | drum tri-color |
| `drummagenta` | drum magenta | drum tri-color |
| `drumyellow` | drum yellow, drum jaune | drum tri-color |

**üí° Astuce** : Si votre imprimante utilise une cartouche **tri-color** (3 couleurs en 1), ajoutez `tri-color` dans le commentaire. Le plugin l'utilisera automatiquement pour les toners cyan, magenta et yellow.

#### V√©rifier les associations

```sql
-- Voir les cartouches compatibles avec r√©f√©rences
SELECT 
    pm.name AS modele,
    ci.name AS cartouche,
    ci.ref AS reference,
    ci.comment AS mapping
FROM glpi_printermodels pm
JOIN glpi_cartridgeitems_printermodels cpm ON cpm.printermodels_id = pm.id
JOIN glpi_cartridgeitems ci ON ci.id = cpm.cartridgeitems_id
WHERE ci.comment IS NOT NULL AND ci.comment != ''
ORDER BY pm.name, ci.name;

-- Voir les propri√©t√©s SNMP remont√©es pour une imprimante
SELECT p.name, c.property, c.value
FROM glpi_printers p
JOIN glpi_printers_cartridgeinfos c ON c.printers_id = p.id
WHERE p.id = 42;  -- Remplacer par l'ID de votre imprimante
```

---

## üîÑ Actions automatiques

### Vue d'ensemble des CronTasks

Le plugin utilise **3 t√¢ches automatiques** qui sont **activ√©es par d√©faut** lors de l'installation :

| CronTask | R√¥le | √âtat initial | Fr√©quence par d√©faut | Horaire recommand√© |
|----------|------|--------------|---------------------|-------------------|
| **CheckTonerLevels** | V√©rifie les niveaux SNMP et met √† jour les √©tats/compteurs | ‚úÖ Actif | Toutes les 6h (21600s) | 00:00, 06:00, 12:00, 18:00 |
| **SendDailyAlerts** | Envoie alertes pour toners avec compteur ‚â§ 3 | ‚úÖ Actif | Quotidien (86400s) | 08:00 |
| **SendWeeklyRecap** | Envoie r√©cap pour toners avec compteur > 3 | ‚úÖ Actif | Hebdomadaire (604800s) | Vendredi 12:00 |

> **üí° Nouveaut√© v1.1.0** : Les CronTasks sont maintenant activ√©s automatiquement √† l'installation. Vous n'avez plus besoin de les activer manuellement, seulement de les configurer si vous souhaitez modifier les horaires.

### Configuration dans GLPI (optionnelle)

Les CronTasks fonctionnent imm√©diatement avec les param√®tres par d√©faut. Si vous souhaitez **personnaliser les horaires** :

1. Aller dans **Configuration ‚Üí Actions automatiques** (ou utiliser le bouton "‚öôÔ∏è Activer/Configurer les CronTasks" depuis la page de configuration du plugin)

2. Rechercher "Toner" ou filtrer par plugin "SNMP Toner Alerts"

3. Pour chaque t√¢che, vous pouvez modifier :

#### CheckTonerLevels

- **√âtat** : ‚úÖ Actif (par d√©faut)
- **Mode d'ex√©cution** : CLI (recommand√©) ou GLPI
- **Fr√©quence** : `21600` secondes (6h) - Ajustable selon vos besoins
- **√âtat de l'ex√©cution** : √Ä planifier

üí° **Recommandation** : Conserver 6h pour un bon √©quilibre entre r√©activit√© et charge serveur.

#### SendDailyAlerts

- **√âtat** : ‚úÖ Actif (par d√©faut)
- **Mode d'ex√©cution** : CLI (via cron syst√®me recommand√©)
- **Fr√©quence** : `86400` secondes (24h)
- **√âtat de l'ex√©cution** : √Ä planifier

üí° **Recommandation** : Configurer un horaire pr√©cis via crontab (ex: 08:00) pour garantir l'envoi √† heure fixe.

#### SendWeeklyRecap

- **√âtat** : ‚úÖ Actif (par d√©faut)
- **Mode d'ex√©cution** : CLI (via cron syst√®me recommand√©)
- **Fr√©quence** : `604800` secondes (7 jours)
- **√âtat de l'ex√©cution** : √Ä planifier

üí° **Recommandation** : Configurer via crontab pour envoi le vendredi √† 12:00.

### Configuration Cron syst√®me (recommand√©)

Pour une ex√©cution **pr√©cise et fiable**, utiliser le crontab syst√®me.

**√âditer le crontab** :

```bash
# En tant que root ou avec sudo
crontab -e
```

**Ajouter les lignes suivantes** :

```bash
# SNMP Toner Alerts - V√©rification des niveaux toutes les 6 heures
0 */6 * * * /usr/bin/php /var/www/html/glpi/front/cron.php --force CheckTonerLevels >> /var/log/glpi/cron.log 2>&1

# SNMP Toner Alerts - Alertes journali√®res √† 8h00
0 8 * * * /usr/bin/php /var/www/html/glpi/front/cron.php --force SendDailyAlerts >> /var/log/glpi/cron.log 2>&1

# SNMP Toner Alerts - R√©capitulatif hebdomadaire vendredi √† 12h00
0 12 * * 5 /usr/bin/php /var/www/html/glpi/front/cron.php --force SendWeeklyRecap >> /var/log/glpi/cron.log 2>&1
```

**Variantes** :

```bash
# Avec le binaire GLPI CLI (si disponible)
0 */6 * * * /usr/bin/php /var/www/html/glpi/bin/console glpi:cron:task CheckTonerLevels

# Avec authentification utilisateur sp√©cifique
0 8 * * * /usr/bin/php /var/www/html/glpi/front/cron.php --force SendDailyAlerts --uid=2

# Avec verbosit√© pour debug
0 12 * * 5 /usr/bin/php /var/www/html/glpi/front/cron.php --force SendWeeklyRecap -vvv
```

**V√©rifier le crontab** :

```bash
# Lister les t√¢ches cron
crontab -l | grep -i snmp

# Tester l'ex√©cution manuelle
/usr/bin/php /var/www/html/glpi/front/cron.php --force CheckTonerLevels

# V√©rifier les logs
tail -f /var/log/glpi/cron.log
```

### Ex√©cution manuelle (test)

**Via l'interface GLPI** :

1. **Configuration ‚Üí Actions automatiques**
2. Cliquer sur la t√¢che (ex: "SendDailyAlerts")
3. Bouton **Ex√©cuter** en haut √† droite
4. V√©rifier le r√©sultat dans l'historique

**Via CLI** :

```bash
# Forcer l'ex√©cution imm√©diate
php /var/www/html/glpi/front/cron.php --force CheckTonerLevels

# Verbose pour debug
php /var/www/html/glpi/front/cron.php --force SendDailyAlerts -vvv

# Toutes les t√¢ches en attente
php /var/www/html/glpi/front/cron.php
```

### Surveillance des CronTasks

**V√©rifier l'historique** :

```sql
-- Derni√®res ex√©cutions
SELECT 
    c.name,
    c.lastrun,
    c.state,
    cl.date AS dernier_log,
    cl.state AS etat_log
FROM glpi_crontasks c
LEFT JOIN glpi_crontasklogs cl ON cl.crontasks_id = c.id
WHERE c.itemtype = 'PluginSnmptonealertsTonerMonitor'
ORDER BY cl.date DESC
LIMIT 10;
```

**Logs GLPI** :

```bash
# Erreurs g√©n√©rales
tail -f /var/log/glpi/php-errors.log

# Logs cron
tail -f /var/log/glpi/cron.log

# SQL en cas d'erreur
tail -f /var/log/glpi/sql-errors.log
```

---

## üìß Templates de notifications

### Fonctionnement

Le plugin utilise le **syst√®me de notifications natif de GLPI** :

1. **√âv√©nements** d√©clench√©s par le plugin :
   - `toner_alert_daily` : Alerte journali√®re
   - `toner_alert_weekly` : R√©capitulatif hebdomadaire

2. **Notifications GLPI** associent √©v√©nements ‚Üí templates ‚Üí destinataires

3. **Templates** sont modifiables via l'interface sans toucher au code

### Acc√®s aux templates

**Configuration ‚Üí Notifications ‚Üí Templates de notifications**

Rechercher :
- `SNMP Toner Alert - Daily`
- `SNMP Toner Alert - Weekly`

### Balises disponibles

Le plugin injecte les balises suivantes dans les templates :

| Balise | Type | Description | Exemple |
|--------|------|-------------|---------|
| `##toner.threshold##` | Scalaire | Seuil d'alerte configur√© (%) | `20` |
| `##toner.count##` | Scalaire | Nombre d'imprimantes en alerte | `5` |
| `##toner.alert_type##` | Scalaire | Type d'alerte | `Journali√®re` / `Hebdomadaire` |
| `##PRINTERS##` | Bloc | Liste d√©taill√©e des imprimantes et toners | Voir structure ci-dessous |

### Structure de la balise ##PRINTERS## (v1.1.0 - Format am√©lior√©)

Cette balise contient un **bloc de texte format√©** avec toutes les imprimantes en alerte :

```
Imprimante: HP-LaserJet-Pro-400-RDC
Localisation: B√¢timent A > RDC > Accueil
Mod√®le: HP LaserJet Pro 400 color M451dn

Toners concern√©s:
  - Toner noir: 19% (HP 305A Black (Ref: CE410A)) [Alerte 2/3]
  - Toner cyan: 15% (HP 305 Tri-color (Ref: CE411A)) [Alerte 2/3]
  - Toner magenta: 18% (Non d√©fini) [Alerte 1/3]

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

Imprimante: Xerox-WorkCentre-5335-Etage1
Localisation: B√¢timent B > √âtage 1 > Bureau
Mod√®le: Xerox WorkCentre 5335

Toners concern√©s:
  - Toner noir: 8% (Xerox 006R01606 Black (Ref: 006R01606)) [Alerte 5/3 - R√©cap hebdomadaire]

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
```

**D√©tails de la structure (nouveaut√© v1.1.0)** :

- **Nom imprimante** : `glpi_printers.name`
- **Localisation** : Chemin complet (Entit√© > Lieu > Sous-lieu)
- **Mod√®le** : `glpi_printermodels.name`
- **Toners** : Format am√©lior√© ‚Üí `Couleur: Niveau% (Nom cartouche (Ref: R√©f√©rence)) [Compteur]`
  - **Nom de la cartouche** : `glpi_cartridgeitems.name` (ex: "HP 305A Black")
  - **R√©f√©rence** : `glpi_cartridgeitems.ref` (ex: "CE410A")
  - **Fallback** : Si non d√©fini ‚Üí affiche "Non d√©fini"
  - **Tri-color** : Support des cartouches multicolores (cyan/magenta/yellow partagent la m√™me ref)
- **S√©parateurs** : Lignes de tirets pour lisibilit√©

> **üí° Nouveaut√© v1.1.0** : Les notifications affichent maintenant **√† la fois le nom et la r√©f√©rence** des cartouches pour faciliter la commande. Si une cartouche n'est pas associ√©e au mod√®le dans GLPI, "Non d√©fini" sera affich√©.

### Exemple de template simple (texte)

**Sujet** :
```
[GLPI] Alertes toners - ##toner.alert_type##
```

**Corps (texte brut)** :
```
Bonjour,

##toner.count## imprimante(s) ont des toners en dessous du seuil d'alerte (##toner.threshold##%).

Type d'alerte: ##toner.alert_type##

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
##PRINTERS##
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

Merci de v√©rifier les niveaux et de commander les cartouches n√©cessaires.

---
SNMP Toner Alerts pour GLPI
Ce message est envoy√© automatiquement.
```

### Exemple de template avanc√© (HTML)

**Corps (HTML)** :

```html
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 28px;
        }
        .alert-info {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            margin: 20px 30px;
            border-radius: 4px;
        }
        .alert-info p {
            margin: 5px 0;
            font-size: 16px;
        }
        .content {
            padding: 30px;
        }
        .printer-block {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .printer-name {
            font-size: 20px;
            font-weight: bold;
            color: #495057;
            margin-bottom: 10px;
        }
        .printer-details {
            color: #6c757d;
            margin: 5px 0;
            font-size: 14px;
        }
        .toner-list {
            margin-top: 15px;
            padding-left: 20px;
        }
        .toner-item {
            background-color: #ffffff;
            border-left: 3px solid #dc3545;
            padding: 10px;
            margin: 8px 0;
            border-radius: 4px;
        }
        .footer {
            background-color: #343a40;
            color: #ffffff;
            text-align: center;
            padding: 20px;
            font-size: 14px;
        }
        .footer a {
            color: #80bdff;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üñ®Ô∏è SNMP Toner Alerts</h1>
            <p>Notification automatique - ##toner.alert_type##</p>
        </div>

        <div class="alert-info">
            <p><strong>üìä Seuil configur√©:</strong> ##toner.threshold##%</p>
            <p><strong>üö® Nombre d'imprimantes concern√©es:</strong> ##toner.count##</p>
        </div>

        <div class="content">
            <h2>D√©tails des alertes</h2>
            <pre style="font-family: inherit; white-space: pre-wrap; background: #f8f9fa; padding: 15px; border-radius: 4px;">##PRINTERS##</pre>

            <p style="margin-top: 30px; padding: 15px; background-color: #e9ecef; border-radius: 4px;">
                <strong>Actions recommand√©es:</strong>
                <ul>
                    <li>V√©rifier les niveaux r√©els sur les imprimantes</li>
                    <li>Commander les cartouches n√©cessaires</li>
                    <li>Pr√©voir le remplacement selon les d√©lais de livraison</li>
                </ul>
            </p>
        </div>

        <div class="footer">
            <p>Ce message est envoy√© automatiquement par le plugin <strong>SNMP Toner Alerts</strong></p>
            <p>Ne pas r√©pondre √† cet email</p>
        </div>
    </div>
</body>
</html>
```

### Modification des templates

**Via l'interface** :

1. **Configuration ‚Üí Notifications ‚Üí Templates de notifications**
2. Cliquer sur le template (ex: "SNMP Toner Alert - Daily")
3. Onglet **Traductions**
4. S√©lectionner la langue (Fran√ßais / Anglais)
5. Modifier :
   - **Sujet de l'email**
   - **Corps de l'email** (Texte et/ou HTML)
6. **Sauvegarder**

**Pr√©visualisation** :

Utiliser **Ex√©cuter** sur le CronTask pour recevoir un email de test.

### Association notifications ‚Üí templates

**Configuration ‚Üí Notifications ‚Üí Notifications**

Rechercher "SNMP Toner Alert" :

| Notification | √âv√©nement | Template |
|--------------|-----------|----------|
| SNMP Toner Alert - Daily | `toner_alert_daily` | SNMP Toner Alert - Daily |
| SNMP Toner Alert - Weekly | `toner_alert_weekly` | SNMP Toner Alert - Weekly |

**V√©rifier** :
- Statut : **Actif** ‚úÖ
- Destinataires : Utilise emails de la config plugin ou **ajouter manuellement** ici
- Mode : Courrier √©lectronique

### Test des notifications

**Depuis l'interface** :

1. **Configuration ‚Üí Actions automatiques**
2. Cliquer sur "SendDailyAlerts"
3. Bouton **Ex√©cuter**
4. V√©rifier r√©ception email

**Depuis CLI** :

```bash
# Forcer envoi des alertes
php /var/www/html/glpi/front/cron.php --force SendDailyAlerts

# V√©rifier les logs
tail -f /var/log/glpi/php-errors.log
```

**V√©rification SQL** :

```sql
-- Voir les notifications en file d'attente
SELECT * FROM glpi_queuednotifications WHERE itemtype = 'PluginSnmptonealertsNotificationTargetTonerAlert';

-- Historique des envois
SELECT * FROM glpi_notificationemails ORDER BY id DESC LIMIT 10;
```

### Personnalisation avanc√©e

**Cr√©er plusieurs templates pour diff√©rents destinataires** :

1. Dupliquer un template existant
2. Modifier le contenu (ex: version courte pour SMS, version longue pour email)
3. Cr√©er plusieurs notifications associ√©es au m√™me √©v√©nement
4. Ajouter des conditions (ex: par entit√©)

**Utiliser des conditions** :

Dans **Configuration ‚Üí Notifications ‚Üí Notifications** :
- Ajouter des crit√®res de destination (Entit√©, Profil, Groupe)
- Permet d'envoyer des templates diff√©rents selon le contexte

---

## üèóÔ∏è Architecture technique

### Sch√©ma de la base de donn√©es

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  glpi_printers       ‚îÇ
‚îÇ  (table native GLPI) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
           ‚îÇ 1:N
           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ glpi_printers_cartridgeinfos     ‚îÇ
‚îÇ (NetInventory SNMP)              ‚îÇ
‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÇ
‚îÇ printers_id                      ‚îÇ
‚îÇ property (tonerblack, cyan...)   ‚îÇ
‚îÇ value (15%)                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
           ‚îÇ Lecture par CheckTonerLevels
           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ glpi_plugin_snmptoneralerts_states     ‚îÇ
‚îÇ (√âtats et compteurs)                   ‚îÇ
‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
‚îÇ printers_id, property_name             ‚îÇ
‚îÇ current_level, alert_count             ‚îÇ
‚îÇ is_alert, last_checked, last_alerted   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
           ‚îÇ Historique
           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ glpi_plugin_snmptoneralerts_alerts     ‚îÇ
‚îÇ (Historique des alertes)               ‚îÇ
‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
‚îÇ printers_id, property_name             ‚îÇ
‚îÇ alert_level, alert_type, notified_at   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ glpi_plugin_snmptoneralerts_configs        ‚îÇ
‚îÇ (Configuration)                            ‚îÇ
‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÇ
‚îÇ threshold, recipients, max_daily_alerts    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ glpi_plugin_snmptoneralerts_excludedprinters    ‚îÇ
‚îÇ (Imprimantes exclues)                           ‚îÇ
‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ‚îÇ
‚îÇ printers_id, reason, excluded_at                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Flux de donn√©es

```
1Ô∏è‚É£ NetInventory (SNMP)
   ‚Üì
   Collecte donn√©es ‚Üí glpi_printers_cartridgeinfos
   ‚Üì
2Ô∏è‚É£ CheckTonerLevels (CronTask toutes les 6h)
   ‚Üì
   Lecture cartridgeinfos
   ‚Üì
   Comparaison avec seuil
   ‚Üì
   Mise √† jour states (is_alert, alert_count)
   ‚Üì
   Insertion historique alerts
   ‚Üì
3Ô∏è‚É£ SendDailyAlerts (CronTask quotidien 08h)
   ‚Üì
   Lecture states WHERE is_alert=1 AND alert_count<=3
   ‚Üì
   G√©n√©ration ##PRINTERS##
   ‚Üì
   QueuedNotification ‚Üí Email
   ‚Üì
4Ô∏è‚É£ SendWeeklyRecap (CronTask vendredi 12h)
   ‚Üì
   Lecture states WHERE is_alert=1 AND alert_count>3
   ‚Üì
   G√©n√©ration ##PRINTERS##
   ‚Üì
   QueuedNotification ‚Üí Email
```

### Classe principale : TonerMonitor

**Fichier** : `src/TonerMonitor.php`

**M√©thodes cl√©s** :

| M√©thode | R√¥le |
|---------|------|
| `checkTonerLevels()` | V√©rifie tous les toners, met √† jour √©tats et compteurs |
| `sendDailyAlerts()` | Envoie alertes pour toners avec compteur ‚â§ max |
| `sendWeeklyRecapitulation()` | Envoie r√©cap pour toners avec compteur > max |
| `getTonersInAlert($type)` | R√©cup√®re liste imprimantes en alerte |
| `getCartridgeReference()` | Mapping SNMP ‚Üí R√©f√©rence cartouche |

### Classe de notification : NotificationTargetTonerAlert

**Fichier** : `src/NotificationTargetTonerAlert.php`

**R√¥le** : G√©n√®re contenu des notifications

**M√©thodes cl√©s** :

| M√©thode | R√¥le |
|---------|------|
| `addDataForTemplate()` | Injecte balises ##toner.*## et ##PRINTERS## |
| `formatPrintersBlock()` | Formate le bloc texte avec imprimantes et toners |
| `getEvents()` | D√©finit √©v√©nements (toner_alert_daily, weekly) |

### PSR-4 Autoloading

**composer.json** :

```json
{
    "autoload": {
        "psr-4": {
            "GlpiPlugin\\Snmptoneralerts\\": "src/"
        }
    }
}
```

**Namespace** : `GlpiPlugin\Snmptoneralerts\`

**Classes** :
- `Config`
- `ItemForm`
- `NotificationTargetTonerAlert`
- `TonerMonitor`

### Hooks GLPI

**Fichier** : `hook.php`

| Hook | Action |
|------|--------|
| `plugin_snmptoneralerts_install()` | Cr√©ation tables, notifications, crontasks |
| `plugin_snmptoneralerts_uninstall()` | Suppression tables et donn√©es |

---

## üîç D√©pannage

### 1. Aucune alerte envoy√©e

**Sympt√¥mes** : Pas d'emails re√ßus malgr√© toners faibles

**Diagnostics** :

```bash
# 1. V√©rifier configuration email GLPI
# Administration ‚Üí Configuration ‚Üí Notifications ‚Üí Email
# Test: Envoyer un email de test

# 2. V√©rifier CronTasks actives
mysql -u glpi -p glpi -e "SELECT name, state, lastrun FROM glpi_crontasks WHERE itemtype = 'PluginSnmptonealertsTonerMonitor';"

# 3. V√©rifier √©tats en alerte
mysql -u glpi -p glpi -e "SELECT COUNT(*) FROM glpi_plugin_snmptoneralerts_states WHERE is_alert = 1;"

# 4. V√©rifier donn√©es SNMP
mysql -u glpi -p glpi -e "SELECT COUNT(*) FROM glpi_printers_cartridgeinfos;"

# 5. Consulter logs
tail -f /var/log/glpi/php-errors.log
tail -f /var/log/glpi/cron.log
```

**Solutions** :

- ‚úÖ Activer notifications email dans GLPI
- ‚úÖ V√©rifier destinataires configur√©s dans plugin
- ‚úÖ Activer et ex√©cuter CronTasks
- ‚úÖ V√©rifier que des toners sont r√©ellement sous seuil
- ‚úÖ Relancer un inventaire SNMP

### 2. Donn√©es SNMP manquantes

**Sympt√¥mes** : `glpi_printers_cartridgeinfos` vide

**Diagnostics** :

```sql
-- V√©rifier table vide
SELECT COUNT(*) FROM glpi_printers_cartridgeinfos;

-- V√©rifier imprimantes inventori√©es
SELECT COUNT(*) FROM glpi_printers WHERE is_deleted = 0;
```

**Solutions** :

1. **V√©rifier NetInventory actif** :
   - Configuration ‚Üí Plugins ‚Üí NetInventory ‚Üí Actif ‚úÖ

2. **V√©rifier credentials SNMP** :
   - Configuration ‚Üí Inventaire ‚Üí √âquipements r√©seau
   - Community SNMP correcte (ex: `public`)

3. **Relancer inventaire manuel** :
   ```bash
   # Via CLI NetInventory
   php /var/www/html/glpi/plugins/fusioninventory/scripts/inventory.php --snmp=192.168.1.100
   ```

4. **V√©rifier SNMP sur l'imprimante** :
   ```bash
   # Tester SNMP depuis serveur GLPI
   snmpwalk -v2c -c public 192.168.1.100 1.3.6.1.2.1.43.11.1.1.9
   # Doit retourner niveaux toners
   ```

### 3. R√©f√©rences cartouches manquantes

**Sympt√¥mes** : Emails affichent "R√©f: N/A"

**Diagnostic** :

```sql
-- V√©rifier associations mod√®le ‚Üí cartouches
SELECT 
    pm.name AS modele,
    ci.ref AS reference,
    ci.comment
FROM glpi_printermodels pm
JOIN glpi_cartridgeitems_printermodels cpm ON cpm.printermodels_id = pm.id
JOIN glpi_cartridgeitems ci ON ci.id = cpm.cartridgeitems_id;
```

**Solutions** :

1. **Ajouter cartouches au mod√®le** :
   - Gestion ‚Üí Mod√®les d'imprimantes
   - S√©lectionner mod√®le
   - Onglet "Cartouches compatibles" ‚Üí Ajouter

2. **Renseigner couleur dans commentaire** :
   - Gestion ‚Üí Cartouches
   - √âditer chaque cartouche
   - Champ "Commentaire" : `black`, `cyan`, `magenta`, `yellow`

### 4. Alertes en double

**Sympt√¥mes** : Plusieurs emails pour la m√™me imprimante en quelques minutes

**Diagnostic** :

```sql
-- Voir compteurs d'alertes
SELECT p.name, s.property_name, s.alert_count, s.last_alerted
FROM glpi_plugin_snmptoneralerts_states s
JOIN glpi_printers p ON p.id = s.printers_id
WHERE s.is_alert = 1;

-- Historique r√©cent
SELECT * FROM glpi_plugin_snmptoneralerts_alerts
WHERE notified_at > NOW() - INTERVAL 1 HOUR;
```

**Solutions** :

- ‚ùå Supprimer cron en double : `crontab -l | grep -i snmp`
- ‚ùå D√©sactiver mode interne GLPI si cron syst√®me utilis√©
- ‚úÖ V√©rifier `last_alerted` met √† jour correctement

### 5. Templates non modifiables

**Sympt√¥mes** : Bouton "Enregistrer" gris√© ou erreur permissions

**Solutions** :

- ‚úÖ Se connecter en profil **Super-Admin**
- ‚úÖ V√©rifier droits : Configuration ‚Üí Profils ‚Üí Super-Admin ‚Üí Notifications (Lecture/√âcriture)
- ‚úÖ V√©rifier que template n'est pas verrouill√© (champ `is_recursive`)

### 6. Erreurs PHP

**Diagnostic** :

```bash
# Logs Apache
tail -f /var/log/apache2/error.log

# Logs PHP-FPM
tail -f /var/log/php8.2-fpm.log

# Logs GLPI
tail -f /var/log/glpi/php-errors.log
tail -f /var/log/glpi/sql-errors.log
```

**Erreurs courantes** :

| Erreur | Cause | Solution |
|--------|-------|----------|
| `Class not found` | Autoload PSR-4 | `composer dump-autoload` |
| `Table doesn't exist` | Plugin non install√© | R√©installer plugin |
| `Call to undefined method` | Version GLPI incompatible | V√©rifier pr√©requis ‚â•11.0 |
| `Memory exhausted` | Trop d'imprimantes | Augmenter `memory_limit` PHP |

### 7. CronTasks ne s'ex√©cutent pas

**Diagnostic** :

```sql
-- Voir √©tat des t√¢ches
SELECT name, state, frequency, lastrun FROM glpi_crontasks 
WHERE itemtype = 'PluginSnmptonealertsTonerMonitor';
```

**Solutions** :

1. **Mode CLI non configur√©** :
   - Ajouter t√¢ches cron syst√®me (voir section Actions automatiques)

2. **Mode GLPI interne** :
   - V√©rifier que `php -f /var/www/html/glpi/front/cron.php` s'ex√©cute
   - Ajouter dans crontab : `*/5 * * * * php /var/www/html/glpi/front/cron.php`

3. **Permissions** :
   ```bash
   chown www-data:www-data /var/www/html/glpi/front/cron.php
   chmod 755 /var/www/html/glpi/front/cron.php
   ```

### 8. Imprimantes exclues par erreur

**Diagnostic** :

```sql
-- Lister exclusions
SELECT e.id, p.name, e.reason, e.excluded_at
FROM glpi_plugin_snmptoneralerts_excludedprinters e
JOIN glpi_printers p ON p.id = e.printers_id;
```

**Solution** :

```sql
-- Supprimer une exclusion (ID 5)
DELETE FROM glpi_plugin_snmptoneralerts_excludedprinters WHERE id = 5;
```

Ou via interface : Configuration ‚Üí SNMP Toner Alerts ‚Üí Section Exclusions ‚Üí Supprimer

### 9. D√©sinstallation / R√©installation

**En cas de corruption** :

```bash
# 1. D√©sactiver le plugin
# Interface: Configuration ‚Üí Plugins ‚Üí SNMP Toner Alerts ‚Üí D√©sactiver

# 2. D√©sinstaller (supprime tables)
# Interface: Configuration ‚Üí Plugins ‚Üí SNMP Toner Alerts ‚Üí D√©sinstaller

# 3. Supprimer dossier
rm -rf /var/www/html/glpi/plugins/snmptoneralerts

# 4. R√©installer (voir section Installation)
```

**‚ö†Ô∏è Attention** : D√©sinstaller supprime **toutes les donn√©es** (historique, exclusions, configuration)

**Sauvegarde avant d√©sinstallation** :

```bash
mysqldump -u root -p glpi \
  glpi_plugin_snmptoneralerts_alerts \
  glpi_plugin_snmptoneralerts_configs \
  glpi_plugin_snmptoneralerts_excludedprinters \
  glpi_plugin_snmptoneralerts_states \
  > snmptoneralerts_backup_$(date +%F).sql
```

---

## üìû Support et ressources

### Documentation

| Ressource | Lien |
|-----------|------|
| üìñ **README** | [README.md](README.md) |
| üìù **CHANGELOG** | [CHANGELOG.md](CHANGELOG.md) |
| ‚öñÔ∏è **LICENCE** | [LICENSE](LICENSE) |

### Communaut√© et support

| Canal | Lien |
|-------|------|
| üêõ **Signaler un bug** | [GitHub Issues](https://github.com/SpyKeeR/snmptoneralerts/issues) |
| üí¨ **Poser une question** | [GitHub Discussions](https://github.com/SpyKeeR/snmptoneralerts/discussions) |
| üåü **Proposer une fonctionnalit√©** | [GitHub Issues (Feature Request)](https://github.com/SpyKeeR/snmptoneralerts/issues/new?labels=enhancement) |

### Avant de signaler un bug

1. ‚úÖ V√©rifier que vous utilisez la derni√®re version
2. ‚úÖ Consulter cette documentation (section D√©pannage)
3. ‚úÖ Rechercher dans les issues existantes
4. ‚úÖ Pr√©parer :
   - Version GLPI
   - Version PHP
   - Logs d'erreur (`/var/log/glpi/php-errors.log`)
   - Capture d'√©cran si erreur interface

---

## üìú Licence

**GPL-3.0-or-later** - Voir fichier [LICENSE](LICENSE)

**R√©sum√© des libert√©s** :

‚úÖ **Utilisation commerciale** : Vous pouvez utiliser ce plugin dans un environnement commercial  
‚úÖ **Modification** : Vous pouvez modifier le code source  
‚úÖ **Distribution** : Vous pouvez redistribuer le plugin  
‚úÖ **Usage priv√©** : Vous pouvez utiliser en priv√©

**Obligations** :

‚ö†Ô∏è **Divulgation de la source** : Code source doit rester accessible  
‚ö†Ô∏è **Licence et copyright** : Conserver les mentions de licence  
‚ö†Ô∏è **Indiquer les modifications** : Mentionner si le code a √©t√© modifi√©  
‚ö†Ô∏è **M√™me licence** : Distribuer sous GPL-3.0

---

**üéâ Merci d'utiliser SNMP Toner Alerts !**

**D√©velopp√© avec ‚ù§Ô∏è par [SpyKeeR](https://github.com/SpyKeeR)**

üìÖ Derni√®re mise √† jour : 31 octobre 2025
